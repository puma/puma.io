<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Puma::ThreadPool &mdash; Puma</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Puma::ThreadPool",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../index.html'>Puma</a> &raquo; 
      <a href='../_index.html#alpha_T'>Index (T)</a> &raquo; 
        <a href="../Puma.html" title="Puma (module)">Puma</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>ThreadPool&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Puma::ThreadPool</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr><td class='box_h' colspan='2'>Namespace Children</td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Classes:</div>
      <div class='box_11'>
          <a href="ThreadPool/Automaton.html" title="Puma::ThreadPool::Automaton (class)">Automaton</a>      </div>
    </td></tr>
    <tr><td colspan='2'>
      <div class='box_1'>Exceptions:</div>
      <div class='box_11'>
          <a href="ThreadPool/ForceShutdown.html" title="Puma::ThreadPool::ForceShutdown (class)">ForceShutdown</a>      </div>
    </td></tr>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'><a href="../Object.html" title="Object (class)">Object</a></span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/puma/puma/blob/v4.3.2/lib/puma/thread_pool.rb#L17'>lib/puma/thread_pool.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>Internal Docs for A simple thread pool management object.</p>

<p>Each Puma “worker” has a thread pool to process requests.</p>

<p>First a connection to a client is made in <a href="Server.html" title="Puma::Server (class)">Server</a>. It is wrapped in a <a href="Client.html" title="Puma::Client (class)">Client</a> instance and then passed to the <a href="Reactor.html" title="Puma::Reactor (class)">Reactor</a> to ensure the whole request is buffered into memory. Once the request is ready, it is passed into a thread pool via the <a href="#<<-instance_method" title="Puma::ThreadPool#&lt;&lt; (method)">#&lt;&lt;</a> operator where it is stored in a <code>@todo</code> array.</p>

<p>Each thread in the pool has an internal loop where it pulls a request from the <code>@todo</code> array and proceses it.</p>

  </div>
</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full'>
  <li>
    <span id='SHUTDOWN_GRACE_TIME-constant' class='summary_signature'>SHUTDOWN_GRACE_TIME =</span>
    <div class='docstring'>
  <div class='discussion'>
    
<p>How long, after raising the <a href="ThreadPool/ForceShutdown.html" title="Puma::ThreadPool::ForceShutdown (class)">ThreadPool::ForceShutdown</a> of a thread during forced shutdown mode, to wait for the thread to try and finish up its work before leaving the thread to die on the vine.</p>

  </div>
</div>
    <a class='repo' href='https://github.com/puma/puma/blob/v4.3.2/lib/puma/thread_pool.rb#L24-L24'># File 'lib/puma/thread_pool.rb', line 24</a>    <pre class='code ruby'><span class='int'>5</span></pre>
  </li>
</ul>
</div>

<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#clean_thread_locals-class_method" title=".clean_thread_locals (class method)">.<strong>clean_thread_locals</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(min, max, *extra, &amp;block)  &#x21d2; ThreadPool </a>
    </span>
    <span class='note title constructor'>constructor</span>
    <div class='summary_desc'>
      <div class='inline'><p>Maintain a minimum of <code>min</code> and maximum of <code>max</code> threads in the pool.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_attribute_summary'>Instance Attribute Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature rw'>
      <a href="#clean_thread_locals-instance_method" title="#clean_thread_locals (instance method)">#<strong>clean_thread_locals</strong>  </a>
    </span>
    <span class='note title rw'>rw</span>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#spawned-instance_method" title="#spawned (instance method)">#<strong>spawned</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#trim_requested-instance_method" title="#trim_requested (instance method)">#<strong>trim_requested</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
  <li>
    <span class='summary_signature ro'>
      <a href="#waiting-instance_method" title="#waiting (instance method)">#<strong>waiting</strong>  </a>
    </span>
    <span class='note title readonly'>readonly</span>
  </li>
</ul>
</div>  <!-- instance_attribute_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#<<-instance_method" title="#&lt;&lt; (instance method)">#<strong>&lt;&lt;</strong>(work)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Add <code>work</code> to the todo list for a Thread to pickup and process.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#auto_reap!-instance_method" title="#auto_reap! (instance method)">#<strong>auto_reap!</strong>(timeout = 5)  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#auto_trim!-instance_method" title="#auto_trim! (instance method)">#<strong>auto_trim!</strong>(timeout = 30)  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#backlog-instance_method" title="#backlog (instance method)">#<strong>backlog</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>How many objects have yet to be processed by the pool?</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#pool_capacity-instance_method" title="#pool_capacity (instance method)">#<strong>pool_capacity</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#reap-instance_method" title="#reap (instance method)">#<strong>reap</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>If there are dead threads in the pool make them go away while decreasing spawned counter so that new healthy threads could be created again.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#shutdown-instance_method" title="#shutdown (instance method)">#<strong>shutdown</strong>(timeout = -1))  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Tell all threads in the pool to exit and wait for them to finish.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#trim-instance_method" title="#trim (instance method)">#<strong>trim</strong>(force = false)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>If too many threads are in the pool, tell one to finish go ahead and exit.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#wait_until_not_full-instance_method" title="#wait_until_not_full (instance method)">#<strong>wait_until_not_full</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>This method is used by <a href="Server.html" title="Puma::Server (class)">Server</a> to let the server know when the thread pool can pull more requests from the socket and pass to the reactor.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature priv nodoc'>
      <a href="#spawn_thread-instance_method" title="#spawn_thread (instance method)">#<strong>spawn_thread</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <span class='nodoc note title'>Internal use only</span>
    <div class='summary_desc'>
      <div class='inline'><p>Must be called with @mutex held!</p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>

  <section class='method_details first' id="new-class_method">
  <h3 class='signature  first'>
    .<strong>new</strong>(min, max, *extra, &amp;block)  &#x21d2; <code>ThreadPool</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Maintain a minimum of <code>min</code> and maximum of <code>max</code> threads in the pool.</p>

<p>The block passed is the work that will be performed in each thread.</p>

  </div>
</div>
<div class='tags'>
  
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/v4.3.2/lib/puma/thread_pool.rb#L32-L61'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='32' data-end='61'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 32</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>(<span class='id identifier rubyid_min'>min</span><span class='comma'>,</span> <span class='id identifier rubyid_max'>max</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_extra'>extra</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>)
  <span class='ivar'>@not_empty</span> <span class='op'>=</span> <span class='const'>ConditionVariable</span>.<span class='id identifier rubyid_new'>new</span>
  <span class='ivar'>@not_full</span> <span class='op'>=</span> <span class='const'>ConditionVariable</span>.<span class='id identifier rubyid_new'>new</span>
  <span class='ivar'>@mutex</span> <span class='op'>=</span> <span class='const'>Mutex</span>.<span class='id identifier rubyid_new'>new</span>

  <span class='ivar'>@todo</span> <span class='op'>=</span> []

  <span class='ivar'>@spawned</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='ivar'>@waiting</span> <span class='op'>=</span> <span class='int'>0</span>

  <span class='ivar'>@min</span> <span class='op'>=</span> <span class='const'>Integer</span>(<span class='id identifier rubyid_min'>min</span>)
  <span class='ivar'>@max</span> <span class='op'>=</span> <span class='const'>Integer</span>(<span class='id identifier rubyid_max'>max</span>)
  <span class='ivar'>@block</span> <span class='op'>=</span> <span class='id identifier rubyid_block'>block</span>
  <span class='ivar'>@extra</span> <span class='op'>=</span> <span class='id identifier rubyid_extra'>extra</span>

  <span class='ivar'>@shutdown</span> <span class='op'>=</span> <span class='kw'>false</span>

  <span class='ivar'>@trim_requested</span> <span class='op'>=</span> <span class='int'>0</span>

  <span class='ivar'>@workers</span> <span class='op'>=</span> []

  <span class='ivar'>@auto_trim</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='ivar'>@reaper</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='ivar'>@mutex</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='ivar'>@min</span>.<span class='id identifier rubyid_times'>times</span> { <span class='id identifier rubyid_spawn_thread'>spawn_thread</span> }
  <span class='kw'>end</span>

  <span class='ivar'>@clean_thread_locals</span> <span class='op'>=</span> <span class='kw'>false</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Class Method Details</h2>
<section class='method_details first' id="clean_thread_locals-class_method">
  <h3 class='signature  first'>
    .<strong>clean_thread_locals</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/v4.3.2/lib/puma/thread_pool.rb#L66-L70'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='66' data-end='70'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 66</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='kw'>self</span>.<span class='id identifier rubyid_clean_thread_locals'>clean_thread_locals</span>
  <span class='const'>Thread</span>.<span class='id identifier rubyid_current'>current</span>.<span class='id identifier rubyid_keys'>keys</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_key'>key</span><span class='op'>|</span> <span class='comment'># rubocop: disable Performance/HashEachMethods
</span>    <span class='const'>Thread</span>.<span class='id identifier rubyid_current'>current</span>[<span class='id identifier rubyid_key'>key</span>] <span class='op'>=</span> <span class='kw'>nil</span> <span class='kw'>unless</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>==</span> <span class='symbeg'>:</span><span class='id identifier rubyid___recursive_key__'>__recursive_key__</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Attribute Details</h2>
<section class='method_details first' id="clean_thread_locals-instance_method">
  <h3 class='signature rw first'>
    #<strong>clean_thread_locals</strong>   <span class="extras">(<span class='rw'>rw</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/v4.3.2/lib/puma/thread_pool.rb#L64-L64'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='64' data-end='64'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 64</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbeg'>:</span><span class='id identifier rubyid_clean_thread_locals'>clean_thread_locals</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="spawned-instance_method">
  <h3 class='signature ro'>
    #<strong>spawned</strong>   <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/v4.3.2/lib/puma/thread_pool.rb#L63-L63'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='63' data-end='63'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 63</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_spawned'>spawned</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_trim_requested'>trim_requested</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_waiting'>waiting</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="trim_requested-instance_method">
  <h3 class='signature ro'>
    #<strong>trim_requested</strong>   <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/v4.3.2/lib/puma/thread_pool.rb#L63-L63'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='63' data-end='63'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 63</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_spawned'>spawned</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_trim_requested'>trim_requested</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_waiting'>waiting</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="waiting-instance_method">
  <h3 class='signature ro'>
    #<strong>waiting</strong>   <span class="extras">(<span class='readonly'>readonly</span>)</span>
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/v4.3.2/lib/puma/thread_pool.rb#L63-L63'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='63' data-end='63'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 63</span></pre>
<pre class='code ruby'>

<span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbeg'>:</span><span class='id identifier rubyid_spawned'>spawned</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_trim_requested'>trim_requested</span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_waiting'>waiting</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="<<-instance_method">
  <h3 class='signature  first'>
    #<strong>&lt;&lt;</strong>(work)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Add <code>work</code> to the todo list for a Thread to pickup and process.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/v4.3.2/lib/puma/thread_pool.rb#L154-L168'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='154' data-end='168'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 154</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='op'>&lt;&lt;</span>(<span class='id identifier rubyid_work'>work</span>)
  <span class='ivar'>@mutex</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='ivar'>@shutdown</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unable to add work while shutting down</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>

    <span class='ivar'>@todo</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_work'>work</span>

    <span class='kw'>if</span> <span class='ivar'>@waiting</span> <span class='op'>&lt;</span> <span class='ivar'>@todo</span>.<span class='id identifier rubyid_size'>size</span> <span class='kw'>and</span> <span class='ivar'>@spawned</span> <span class='op'>&lt;</span> <span class='ivar'>@max</span>
      <span class='id identifier rubyid_spawn_thread'>spawn_thread</span>
    <span class='kw'>end</span>

    <span class='ivar'>@not_empty</span>.<span class='id identifier rubyid_signal'>signal</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="auto_reap!-instance_method">
  <h3 class='signature '>
    #<strong>auto_reap!</strong>(timeout = 5)  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/v4.3.2/lib/puma/thread_pool.rb#L278-L281'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='278' data-end='281'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 278</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_auto_reap!'>auto_reap!</span>(<span class='id identifier rubyid_timeout'>timeout</span><span class='op'>=</span><span class='int'>5</span>)
  <span class='ivar'>@reaper</span> <span class='op'>=</span> <span class='const'><a href="ThreadPool/Automaton.html" title="Puma::ThreadPool::Automaton (class)">Automaton</a></span>.<span class='id identifier rubyid_new'><a href="ThreadPool/Automaton.html#new-class_method" title="Puma::ThreadPool::Automaton.new (method)">new</a></span>(<span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>threadpool reaper</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_reap'>reap</span>)
  <span class='ivar'>@reaper</span>.<span class='id identifier rubyid_start!'>start!</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="auto_trim!-instance_method">
  <h3 class='signature '>
    #<strong>auto_trim!</strong>(timeout = 30)  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/v4.3.2/lib/puma/thread_pool.rb#L273-L276'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='273' data-end='276'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 273</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_auto_trim!'>auto_trim!</span>(<span class='id identifier rubyid_timeout'>timeout</span><span class='op'>=</span><span class='int'>30</span>)
  <span class='ivar'>@auto_trim</span> <span class='op'>=</span> <span class='const'><a href="ThreadPool/Automaton.html" title="Puma::ThreadPool::Automaton (class)">Automaton</a></span>.<span class='id identifier rubyid_new'><a href="ThreadPool/Automaton.html#new-class_method" title="Puma::ThreadPool::Automaton.new (method)">new</a></span>(<span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>threadpool trimmer</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbeg'>:</span><span class='id identifier rubyid_trim'>trim</span>)
  <span class='ivar'>@auto_trim</span>.<span class='id identifier rubyid_start!'>start!</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="backlog-instance_method">
  <h3 class='signature '>
    #<strong>backlog</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>How many objects have yet to be processed by the pool?</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/v4.3.2/lib/puma/thread_pool.rb#L74-L76'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='74' data-end='76'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 74</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_backlog'>backlog</span>
  <span class='ivar'>@mutex</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> { <span class='ivar'>@todo</span>.<span class='id identifier rubyid_size'>size</span> }
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="pool_capacity-instance_method">
  <h3 class='signature '>
    #<strong>pool_capacity</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/v4.3.2/lib/puma/thread_pool.rb#L78-L80'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='78' data-end='80'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 78</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_pool_capacity'>pool_capacity</span>
  <span class='id identifier rubyid_waiting'>waiting</span> <span class='op'>+</span> (<span class='ivar'>@max</span> <span class='op'>-</span> <span class='id identifier rubyid_spawned'>spawned</span>)
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="reap-instance_method">
  <h3 class='signature '>
    #<strong>reap</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>If there are dead threads in the pool make them go away while decreasing spawned counter so that new healthy threads could be created again.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/v4.3.2/lib/puma/thread_pool.rb#L231-L244'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='231' data-end='244'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 231</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_reap'>reap</span>
  <span class='ivar'>@mutex</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_dead_workers'>dead_workers</span> <span class='op'>=</span> <span class='ivar'>@workers</span>.<span class='id identifier rubyid_reject'>reject</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_alive?'>alive?</span>)

    <span class='id identifier rubyid_dead_workers'>dead_workers</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_worker'>worker</span><span class='op'>|</span>
      <span class='id identifier rubyid_worker'>worker</span>.<span class='id identifier rubyid_kill'>kill</span>
      <span class='ivar'>@spawned</span> <span class='op'>-=</span> <span class='int'>1</span>
    <span class='kw'>end</span>

    <span class='ivar'>@workers</span>.<span class='id identifier rubyid_delete_if'>delete_if</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_w'>w</span><span class='op'>|</span>
      <span class='id identifier rubyid_dead_workers'>dead_workers</span>.<span class='id identifier rubyid_include?'>include?</span>(<span class='id identifier rubyid_w'>w</span>)
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="shutdown-instance_method">
  <h3 class='signature '>
    #<strong>shutdown</strong>(timeout = -1))  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Tell all threads in the pool to exit and wait for them to finish.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/v4.3.2/lib/puma/thread_pool.rb#L285-L326'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='285' data-end='326'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 285</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_shutdown'>shutdown</span>(<span class='id identifier rubyid_timeout'>timeout</span><span class='op'>=</span><span class='op'>-</span><span class='int'>1</span>)
  <span class='id identifier rubyid_threads'>threads</span> <span class='op'>=</span> <span class='ivar'>@mutex</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='ivar'>@shutdown</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='ivar'>@not_empty</span>.<span class='id identifier rubyid_broadcast'>broadcast</span>
    <span class='ivar'>@not_full</span>.<span class='id identifier rubyid_broadcast'>broadcast</span>

    <span class='ivar'>@auto_trim</span>.<span class='id identifier rubyid_stop'>stop</span> <span class='kw'>if</span> <span class='ivar'>@auto_trim</span>
    <span class='ivar'>@reaper</span>.<span class='id identifier rubyid_stop'>stop</span> <span class='kw'>if</span> <span class='ivar'>@reaper</span>
    <span class='comment'># dup workers so that we join them all safely
</span>    <span class='ivar'>@workers</span>.<span class='id identifier rubyid_dup'>dup</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>==</span> <span class='op'>-</span><span class='int'>1</span>
    <span class='comment'># Wait for threads to finish without force shutdown.
</span>    <span class='id identifier rubyid_threads'>threads</span>.<span class='id identifier rubyid_each'>each</span>(<span class='op'>&amp;</span><span class='symbeg'>:</span><span class='id identifier rubyid_join'>join</span>)
  <span class='kw'>else</span>
    <span class='comment'># Wait for threads to finish after n attempts (timeout).
</span>    <span class='comment'># If threads are still running, it will forcefully kill them.
</span>    <span class='id identifier rubyid_timeout'>timeout</span>.<span class='id identifier rubyid_times'>times</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_threads'>threads</span>.<span class='id identifier rubyid_delete_if'>delete_if</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
        <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_join'>join</span> <span class='int'>1</span>
      <span class='kw'>end</span>

      <span class='kw'>if</span> <span class='id identifier rubyid_threads'>threads</span>.<span class='id identifier rubyid_empty?'>empty?</span>
        <span class='kw'>break</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_sleep'>sleep</span> <span class='int'>1</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_threads'>threads</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_raise'>raise</span> <span class='const'><a href="ThreadPool/ForceShutdown.html" title="Puma::ThreadPool::ForceShutdown (class)">ForceShutdown</a></span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_threads'>threads</span>.<span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
      <span class='id identifier rubyid_t'>t</span>.<span class='id identifier rubyid_join'>join</span> <span class='const'><a href="#SHUTDOWN_GRACE_TIME-constant" title="Puma::ThreadPool::SHUTDOWN_GRACE_TIME (constant)">SHUTDOWN_GRACE_TIME</a></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='ivar'>@spawned</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='ivar'>@workers</span> <span class='op'>=</span> []
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="spawn_thread-instance_method">
  <h3 class='signature priv  nodoc'>
    #<strong>spawn_thread</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
  <div class='note nodoc inline-block'>
    <strong>This method is for internal use only.</strong>
  </div><div></div>
<div class='docstring'>
  <div class='discussion'>
    
<p>Must be called with @mutex held!</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/v4.3.2/lib/puma/thread_pool.rb#L86-L149'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='86' data-end='149'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 86</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_spawn_thread'>spawn_thread</span>
  <span class='ivar'>@spawned</span> <span class='op'>+=</span> <span class='int'>1</span>

  <span class='id identifier rubyid_th'>th</span> <span class='op'>=</span> <span class='const'>Thread</span>.<span class='id identifier rubyid_new'>new</span>(<span class='ivar'>@spawned</span>) <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_spawned'>spawned</span><span class='op'>|</span>
    <span class='const'><a href="../Puma.html" title="Puma (module)">Puma</a></span>.<span class='id identifier rubyid_set_thread_name'><a href="../Puma.html#set_thread_name-class_method" title="Puma.set_thread_name (method)">set_thread_name</a></span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>threadpool %03i</span><span class='tstring_end'>&#39;</span></span> <span class='op'>%</span> <span class='id identifier rubyid_spawned'>spawned</span>
    <span class='id identifier rubyid_todo'>todo</span>  <span class='op'>=</span> <span class='ivar'>@todo</span>
    <span class='id identifier rubyid_block'>block</span> <span class='op'>=</span> <span class='ivar'>@block</span>
    <span class='id identifier rubyid_mutex'>mutex</span> <span class='op'>=</span> <span class='ivar'>@mutex</span>
    <span class='id identifier rubyid_not_empty'>not_empty</span> <span class='op'>=</span> <span class='ivar'>@not_empty</span>
    <span class='id identifier rubyid_not_full'>not_full</span> <span class='op'>=</span> <span class='ivar'>@not_full</span>

    <span class='id identifier rubyid_extra'>extra</span> <span class='op'>=</span> <span class='ivar'>@extra</span>.<span class='id identifier rubyid_map'>map</span> { <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span> <span class='id identifier rubyid_i'>i</span>.<span class='id identifier rubyid_new'>new</span> }

    <span class='kw'>while</span> <span class='kw'>true</span>
      <span class='id identifier rubyid_work'>work</span> <span class='op'>=</span> <span class='kw'>nil</span>

      <span class='id identifier rubyid_continue'>continue</span> <span class='op'>=</span> <span class='kw'>true</span>

      <span class='id identifier rubyid_mutex'>mutex</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
        <span class='kw'>while</span> <span class='id identifier rubyid_todo'>todo</span>.<span class='id identifier rubyid_empty?'>empty?</span>
          <span class='kw'>if</span> <span class='ivar'>@trim_requested</span> <span class='op'>&gt;</span> <span class='int'>0</span>
            <span class='ivar'>@trim_requested</span> <span class='op'>-=</span> <span class='int'>1</span>
            <span class='id identifier rubyid_continue'>continue</span> <span class='op'>=</span> <span class='kw'>false</span>
            <span class='id identifier rubyid_not_full'>not_full</span>.<span class='id identifier rubyid_signal'>signal</span>
            <span class='kw'>break</span>
          <span class='kw'>end</span>

          <span class='kw'>if</span> <span class='ivar'>@shutdown</span>
            <span class='id identifier rubyid_continue'>continue</span> <span class='op'>=</span> <span class='kw'>false</span>
            <span class='kw'>break</span>
          <span class='kw'>end</span>

          <span class='ivar'>@waiting</span> <span class='op'>+=</span> <span class='int'>1</span>
          <span class='id identifier rubyid_not_full'>not_full</span>.<span class='id identifier rubyid_signal'>signal</span>
          <span class='id identifier rubyid_not_empty'>not_empty</span>.<span class='id identifier rubyid_wait'>wait</span> <span class='id identifier rubyid_mutex'>mutex</span>
          <span class='ivar'>@waiting</span> <span class='op'>-=</span> <span class='int'>1</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_work'>work</span> <span class='op'>=</span> <span class='id identifier rubyid_todo'>todo</span>.<span class='id identifier rubyid_shift'>shift</span> <span class='kw'>if</span> <span class='id identifier rubyid_continue'>continue</span>
      <span class='kw'>end</span>

      <span class='kw'>break</span> <span class='kw'>unless</span> <span class='id identifier rubyid_continue'>continue</span>

      <span class='kw'>if</span> <span class='ivar'>@clean_thread_locals</span>
        <span class='const'><a href="" title="Puma::ThreadPool (class)">ThreadPool</a></span>.<span class='id identifier rubyid_clean_thread_locals'><a href="#clean_thread_locals-class_method" title="Puma::ThreadPool.clean_thread_locals (method)">clean_thread_locals</a></span>
      <span class='kw'>end</span>

      <span class='kw'>begin</span>
        <span class='id identifier rubyid_block'>block</span>.<span class='id identifier rubyid_call'>call</span>(<span class='id identifier rubyid_work'>work</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_extra'>extra</span>)
      <span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
        <span class='const'>STDERR</span>.<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Error reached top of thread-pool: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_content'> (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span>.<span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_mutex'>mutex</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
      <span class='ivar'>@spawned</span> <span class='op'>-=</span> <span class='int'>1</span>
      <span class='ivar'>@workers</span>.<span class='id identifier rubyid_delete'>delete</span> <span class='id identifier rubyid_th'>th</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='ivar'>@workers</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_th'>th</span>

  <span class='id identifier rubyid_th'>th</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="trim-instance_method">
  <h3 class='signature '>
    #<strong>trim</strong>(force = false)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>If too many threads are in the pool, tell one to finish go ahead and exit. If <code>force</code> is true, then a trim request is requested even if all threads are being utilized.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/v4.3.2/lib/puma/thread_pool.rb#L220-L227'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='220' data-end='227'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 220</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_trim'>trim</span>(<span class='id identifier rubyid_force'>force</span><span class='op'>=</span><span class='kw'>false</span>)
  <span class='ivar'>@mutex</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='kw'>if</span> (<span class='id identifier rubyid_force'>force</span> <span class='kw'>or</span> <span class='ivar'>@waiting</span> <span class='op'>&gt;</span> <span class='int'>0</span>) <span class='kw'>and</span> <span class='ivar'>@spawned</span> <span class='op'>-</span> <span class='ivar'>@trim_requested</span> <span class='op'>&gt;</span> <span class='ivar'>@min</span>
      <span class='ivar'>@trim_requested</span> <span class='op'>+=</span> <span class='int'>1</span>
      <span class='ivar'>@not_empty</span>.<span class='id identifier rubyid_signal'>signal</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="wait_until_not_full-instance_method">
  <h3 class='signature '>
    #<strong>wait_until_not_full</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>This method is used by <a href="Server.html" title="Puma::Server (class)">Server</a> to let the server know when the thread pool can pull more requests from the socket and pass to the reactor.</p>

<p>The general idea is that the thread pool can only work on a fixed number of requests at the same time. If it is already processing that number of requests then it is at capacity. If another <a href="../Puma.html" title="Puma (module)">::Puma</a> process has spare capacity, then the request can be left on the socket so the other worker can pick it up and process it.</p>

<p>For example: if there are 5 threads, but only 4 working on requests, this method will not wait and the <a href="Server.html" title="Puma::Server (class)">Server</a> can pull a request right away.</p>

<p>If there are 5 threads and all 5 of them are busy, then it will pause here, and wait until the <code>not_full</code> condition variable is signaled, usually this indicates that a request has been processed.</p>

<p>It&#39;s important to note that even though the server might accept another request, it might not be added to the <code>@todo</code> array right away. For example if a slow client has only sent a header, but not a body then the <code>@todo</code> array would stay the same size as the reactor works to try to buffer the request. In that scenario the next call to this method would not block and another request would be added into the reactor by the server. This would continue until a fully bufferend request makes it through the reactor and can then be processed by the thread pool.</p>

<p>Returns the current number of busy threads, or <code>nil</code> if shutting down.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/v4.3.2/lib/puma/thread_pool.rb#L199-L214'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='199' data-end='214'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/thread_pool.rb', line 199</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_wait_until_not_full'>wait_until_not_full</span>
  <span class='ivar'>@mutex</span>.<span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='kw'>while</span> <span class='kw'>true</span>
      <span class='kw'>return</span> <span class='kw'>if</span> <span class='ivar'>@shutdown</span>

      <span class='comment'># If we can still spin up new threads and there
</span>      <span class='comment'># is work queued that cannot be handled by waiting
</span>      <span class='comment'># threads, then accept more work until we would
</span>      <span class='comment'># spin up the max number of threads.
</span>      <span class='id identifier rubyid_busy_threads'>busy_threads</span> <span class='op'>=</span> <span class='ivar'>@spawned</span> <span class='op'>-</span> <span class='ivar'>@waiting</span> <span class='op'>+</span> <span class='ivar'>@todo</span>.<span class='id identifier rubyid_size'>size</span>
      <span class='kw'>return</span> <span class='id identifier rubyid_busy_threads'>busy_threads</span> <span class='kw'>if</span> <span class='ivar'>@max</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_busy_threads'>busy_threads</span>

      <span class='ivar'>@not_full</span>.<span class='id identifier rubyid_wait'>wait</span> <span class='ivar'>@mutex</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>